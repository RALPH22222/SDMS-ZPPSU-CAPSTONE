<?php
  $pageTitle = 'Admin Dashboard - SDMS';
  require_once '../../components/admin-head.php';
  require_once '../../database/database.php';
  function fetchScalar($pdo, $sql, $params = []) {
    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $val = $stmt->fetchColumn();
    return $val ? (int)$val : 0;
  }
  $totalUsers = fetchScalar($pdo, "SELECT COUNT(*) FROM users");
  $activeUsers = fetchScalar($pdo, "SELECT COUNT(*) FROM users WHERE is_active = 1");
  $inactiveUsers = $totalUsers - $activeUsers;
  $roleCount = fetchScalar($pdo, "SELECT COUNT(*) FROM roles");
  $violationCategories = fetchScalar($pdo, "SELECT COUNT(*) FROM violation_categories");
  $violationTypes = fetchScalar($pdo, "SELECT COUNT(*) FROM violation_types");
  $teacherCount = fetchScalar($pdo, "SELECT COUNT(*) FROM users WHERE role_id = 5");
  $totalCases = fetchScalar($pdo, "SELECT COUNT(*) FROM cases");
  $resolvedCases = fetchScalar($pdo, "SELECT COUNT(*) FROM cases WHERE status_id = 4");
  $openCases = $totalCases - $resolvedCases;
  $notificationCount = fetchScalar($pdo, "SELECT COUNT(*) FROM notifications");
  $auditTrailCount = fetchScalar($pdo, "SELECT COUNT(*) FROM audit_trail");
  $casesByStatus = [];
  $stmt = $pdo->query("
    SELECT cs.name AS status_name, COUNT(c.id) AS cnt
    FROM case_status cs
    LEFT JOIN cases c ON c.status_id = cs.id
    GROUP BY cs.id, cs.name
    ORDER BY cs.id
  ");
  while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $casesByStatus[] = $row;
  }
  $casesPerMonth = [];
  $stmt = $pdo->query("
    SELECT DATE_FORMAT(incident_date, '%Y-%m') AS ym, COUNT(*) AS cnt
    FROM cases
    WHERE incident_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
    GROUP BY ym
    ORDER BY ym
  ");
  while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $casesPerMonth[$row['ym']] = (int)$row['cnt'];
  }
  $topCategories = [];
  $stmt = $pdo->query("
    SELECT vc.name AS category, COUNT(c.id) AS cnt
    FROM violation_categories vc
    LEFT JOIN violation_types vt ON vt.category_id = vc.id
    LEFT JOIN cases c ON c.violation_type_id = vt.id
    GROUP BY vc.id, vc.name
    ORDER BY cnt DESC
    LIMIT 5
  ");
  while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $topCategories[] = $row;
  }
  $statusLabels = array_map(fn($r) => $r['status_name'], $casesByStatus);
  $statusCounts = array_map(fn($r) => (int)$r['cnt'], $casesByStatus);
  $monthLabels = [];
  $monthCounts = [];
  for ($i = 5; $i >= 0; $i--) {
    $ym = date('Y-m', strtotime("-$i months"));
    $monthLabels[] = date('M Y', strtotime("$ym-01"));
    $monthCounts[] = $casesPerMonth[$ym] ?? 0;
  }

  $catLabels = array_map(fn($r) => $r['category'], $topCategories);
  $catCounts = array_map(fn($r) => (int)$r['cnt'], $topCategories);

  // Fetch department statistics
  $departmentsData = [];
  $departmentLabels = [];
  $departmentCounts = [];
  $departmentColors = [];
  
  $stmt = $pdo->query("
    SELECT 
      d.department_name AS Department, 
      COUNT(ca.id) AS Total_Cases
    FROM cases ca
    JOIN students s ON ca.student_id = s.id
    JOIN courses co ON s.course_id = co.id
    JOIN departments d ON co.department_id = d.id
    GROUP BY d.department_name
    ORDER BY Total_Cases DESC
    LIMIT 5
  ");
  
  // Function to generate a color palette with good contrast
  function generateColorPalette($count, $saturation = 70, $lightness = 60) {
    $colors = [];
    $hueStep = 360 / max($count, 1);
    
    for ($i = 0; $i < $count; $i++) {
      $hue = ($i * $hueStep) % 360;
      $colors[] = "hsl($hue, {$saturation}%, {$lightness}%)";
    }
    
    return $colors;
  }
  
  // Fetch all department data first to know the count
  $departmentsData = [];
  $departmentLabels = [];
  $departmentCounts = [];
  
  while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $departmentsData[] = $row;
    $departmentLabels[] = $row['Department'];
    $departmentCounts[] = (int)$row['Total_Cases'];
  }
  
  // Generate colors based on the number of departments
  $departmentColors = generateColorPalette(count($departmentLabels));
  
  // Fetch course statistics
  $coursesData = [];
  $courseLabels = [];
  $courseCounts = [];
  $courseColors = [];
  
  $stmt = $pdo->query("
    SELECT 
      CONCAT(co.course_name, ' (', co.course_code, ')') AS Course,
      COUNT(ca.id) AS Total_Cases
    FROM cases ca
    JOIN students s ON ca.student_id = s.id
    JOIN courses co ON s.course_id = co.id
    GROUP BY co.course_name, co.course_code
    ORDER BY Total_Cases DESC
    LIMIT 5
  ");
  
  // Fetch all course data first to know the count
  $coursesData = [];
  $courseLabels = [];
  $courseCounts = [];
  
  while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $coursesData[] = $row;
    $courseLabels[] = $row['Course'];
    $courseCounts[] = (int)$row['Total_Cases'];
  }
  
  // Generate colors for courses with a different saturation/lightness for visual distinction
  $courseColors = generateColorPalette(count($courseLabels), 65, 55);
?>

<div class="min-h-screen md:pl-64">
  <!-- Mobile Header -->
  <div class="md:hidden sticky top-0 z-40 bg-white border-b border-gray-200">
    <div class="h-16 flex items-center px-4">
      <button id="adminSidebarToggle" class="text-primary text-2xl mr-3">
        <i class="fa-solid fa-bars"></i>
      </button>
      <div class="text-primary font-bold flex-grow">Admin Dashboard</div>
      <a href="manage-notification.php" class="relative text-primary text-2xl p-2 hover:bg-gray-100 rounded-full transition-colors duration-200">
        <i class="fa-solid fa-bell"></i>
        <?php if ($notificationCount > 0): ?>
          <span class="absolute -top-0.5 -right-0.5 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center shadow-sm">
            <?php echo $notificationCount > 9 ? '9+' : $notificationCount; ?>
          </span>
        <?php endif; ?>
      </a>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="hidden md:flex sticky top-0 z-40 bg-white border-b border-gray-200 h-16 items-center px-6 justify-between">
    <h1 class="text-xl font-bold text-primary">Dashboard</h1>
    <div class="flex items-center space-x-4">
      <a href="manage-notification.php" class="relative text-primary text-2xl p-2 hover:bg-gray-100 rounded-full transition-colors duration-200">
        <i class="fa-solid fa-bell"></i>
        <?php if ($notificationCount > 0): ?>
          <span class="absolute -top-0.5 -right-0.5 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center shadow-sm">
            <?php echo $notificationCount > 9 ? '9+' : $notificationCount; ?>
          </span>
        <?php endif; ?>
      </a>
      <!-- Add user profile or other header items here if needed -->
    </div>
  </div>

  <?php include '../../components/admin-sidebar.php'; ?>

  <main class="px-4 md:px-8 py-6">
    <div class="flex items-center gap-3 mb-6">
      <i class="fa-solid fa-gauge text-primary text-2xl"></i>
      <h1 class="text-2xl md:text-3xl font-bold text-primary">Dashboard</h1>
    </div>
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8 px-2 sm:px-0">
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Manage Users</h3>
          <i class="fa-solid fa-users text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $totalUsers; ?></div>
        <div class="text-sm text-gray">Active: <?php echo $activeUsers; ?> • Inactive: <?php echo $inactiveUsers; ?></div>
        <a href="manage-user.php" class="text-sm text-primary hover:underline mt-3 inline-block">Go to Users</a>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Roles & Permissions</h3>
          <i class="fa-solid fa-user-shield text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $roleCount; ?></div>
        <div class="text-sm text-gray">Total roles</div>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Violation Categories</h3>
          <i class="fa-solid fa-triangle-exclamation text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $violationCategories; ?></div>
        <div class="text-sm text-gray">Types: <?php echo $violationTypes; ?></div>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Teachers</h3>
          <i class="fa-solid fa-chalkboard-user text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $teacherCount; ?></div>
        <div class="text-sm text-gray">Assigned via classes</div>
        <a href="manage-teachers.php" class="text-sm text-primary hover:underline mt-3 inline-block">Manage Teachers</a>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">All Cases</h3>
          <i class="fa-solid fa-folder-open text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $totalCases; ?></div>
        <div class="text-sm text-gray">Open: <?php echo $openCases; ?> • Resolved: <?php echo $resolvedCases; ?></div>
        <a href="manage-cases.php" class="text-sm text-primary hover:underline mt-3 inline-block">View & Filter</a>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Reports & Export</h3>
          <i class="fa-solid fa-file-export text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1">—</div>
        <div class="text-sm text-gray">Generate reports, export data</div>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Audit Trail</h3>
          <i class="fa-solid fa-list-check text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $auditTrailCount; ?></div>
        <div class="text-sm text-gray">Total audit events</div>
        <a href="../Admin/activity-log.php" class="text-sm text-primary hover:underline mt-3 inline-block">View Audit Trail</a>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow transition">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-dark">Notifications</h3>
          <i class="fa-solid fa-bell text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-primary mb-1"><?php echo $notificationCount; ?></div>
        <div class="text-sm text-gray">Unread and sent</div>
        <a href="manage-notification.php" class="text-sm text-primary hover:underline mt-3 inline-block">Manage Notifications</a>
      </div>
    </section>
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 px-2 sm:px-0">
      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 shadow-sm h-full">
        <h3 class="font-semibold text-dark mb-4">Cases by Status</h3>
        <canvas id="chartStatus" height="200"></canvas>
      </div>

      <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 shadow-sm lg:col-span-2 h-full">
        <h3 class="font-semibold text-dark mb-4">Cases per Month (Last 6 Months)</h3>
        <canvas id="chartMonthly" height="200"></canvas>
      </div>

      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm lg:col-span-3">
        <h3 class="font-semibold text-dark mb-4">Top Violation Categories</h3>
        <canvas id="chartCategories" height="120"></canvas>
      </div>

      <!-- 3D Pie Chart Section -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm lg:col-span-3">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-dark">Case Distribution</h3>
          <div class="inline-flex rounded-md shadow-sm" role="group">
            <button type="button" id="tab-department" class="px-4 py-2 text-sm font-medium rounded-l-lg border border-gray-200 bg-primary text-white hover:bg-primary/90 focus:z-10 focus:ring-2 focus:ring-primary/50">
              By Department
            </button>
            <button type="button" id="tab-course" class="px-4 py-2 text-sm font-medium rounded-r-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-primary/50">
              By Course
            </button>
          </div>
        </div>
        
        <div class="relative h-96">
          <!-- Department Chart -->
          <div id="department-chart" class="chart-container transition-opacity duration-300">
            <canvas id="chartDepartment"></canvas>
          </div>
          
          <!-- Course Chart (initially hidden) -->
          <div id="course-chart" class="chart-container opacity-0 absolute inset-0 transition-opacity duration-300">
            <canvas id="chartCourse"></canvas>
          </div>
          
          <!-- No Data Message -->
          <div id="no-data-message" class="hidden h-full flex items-center justify-center">
            <p class="text-gray-500">No data available</p>
          </div>
        </div>
        
        <div class="mt-4 text-sm text-gray-500 text-center">
          <p>Showing top <?php echo min(5, max(count($departmentLabels), count($courseLabels))); ?> items with the highest number of cases</p>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const statusLabels = <?php echo json_encode($statusLabels); ?>;
  const statusCounts = <?php echo json_encode($statusCounts); ?>;
  const monthLabels = <?php echo json_encode($monthLabels); ?>;
  const monthCounts = <?php echo json_encode($monthCounts); ?>;
  const catLabels = <?php echo json_encode($catLabels); ?>;
  const catCounts = <?php echo json_encode($catCounts); ?>;
  const colorPrimary = '#800000';
  const colorSecondary = '#a52a2a';
  const palette = ['#800000','#a52a2a','#d2691e','#6c757d','#333333','#f5a623','#50e3c2','#4a90e2'];
  const ctxStatus = document.getElementById('chartStatus').getContext('2d');
  new Chart(ctxStatus, {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusCounts,
        backgroundColor: palette.slice(0, statusCounts.length),
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { position: 'bottom' } }
    }
  });
  const ctxMonthly = document.getElementById('chartMonthly').getContext('2d');
  new Chart(ctxMonthly, {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'Cases',
        data: monthCounts,
        borderColor: colorPrimary,
        backgroundColor: colorPrimary + '33',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
  const ctxCategories = document.getElementById('chartCategories').getContext('2d');
  new Chart(ctxCategories, {
    type: 'bar',
    data: {
      labels: catLabels,
      datasets: [{
        label: 'Cases',
        data: catCounts,
        backgroundColor: colorSecondary
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });

  // 3D Pie Chart Data
  const departmentData = {
    labels: <?php echo json_encode($departmentLabels); ?>,
    datasets: [{
      data: <?php echo json_encode($departmentCounts); ?>,
      backgroundColor: <?php echo json_encode($departmentColors); ?>,
      borderWidth: 1
    }]
  };

  const courseData = {
    labels: <?php echo json_encode($courseLabels); ?>,
    datasets: [{
      data: <?php echo json_encode($courseCounts); ?>,
      backgroundColor: <?php echo json_encode($courseColors); ?>
    }]
  };

  // Chart options with 3D effect
  const pieOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: {
          padding: 20,
          usePointStyle: true,
          pointStyle: 'circle',
          boxWidth: 8,
          font: {
            size: 12
          }
        }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const label = context.label || '';
            const value = context.raw || 0;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = Math.round((value / total) * 100);
            return `${label}: ${value} (${percentage}%)`;
          }
        }
      }
    },
    cutout: '60%',
    borderRadius: 6,
    borderWidth: 2,
    borderColor: '#fff',
    animation: {
      animateScale: true,
      animateRotate: true
    },
    layout: {
      padding: 20
    },
    elements: {
      arc: {
        borderWidth: 0,
        borderColor: '#fff'
      }
    }
  };

  // Initialize department chart
  const ctxDept = document.getElementById('chartDepartment').getContext('2d');
  const deptChart = new Chart(ctxDept, {
    type: 'doughnut',
    data: departmentData,
    options: pieOptions
  });

  // Initialize course chart (initially hidden)
  const ctxCourse = document.getElementById('chartCourse').getContext('2d');
  const courseChart = new Chart(ctxCourse, {
    type: 'doughnut',
    data: courseData,
    options: pieOptions
  });

  // Tab switching functionality
  const tabDepartment = document.getElementById('tab-department');
  const tabCourse = document.getElementById('tab-course');
  const deptChartEl = document.getElementById('department-chart');
  const courseChartEl = document.getElementById('course-chart');
  const noDataEl = document.getElementById('no-data-message');

  // Check if we have data for either chart
  const hasDeptData = departmentData.labels.length > 0;
  const hasCourseData = courseData.labels.length > 0;

  // Show/hide no data message
  if (!hasDeptData && !hasCourseData) {
    noDataEl.classList.remove('hidden');
    noDataEl.classList.add('flex');
    deptChartEl.style.display = 'none';
    courseChartEl.style.display = 'none';
  } else if (!hasDeptData) {
    // If no department data, show course data by default
    tabDepartment.disabled = true;
    tabCourse.click();
  } else if (!hasCourseData) {
    // If no course data, disable course tab
    tabCourse.disabled = true;
  }

  // Department tab click handler
  tabDepartment.addEventListener('click', function() {
    if (this.classList.contains('bg-white')) {
      this.classList.remove('bg-white', 'text-gray-700');
      this.classList.add('bg-primary', 'text-white');
      tabCourse.classList.remove('bg-primary', 'text-white');
      tabCourse.classList.add('bg-white', 'text-gray-700');
      
      deptChartEl.classList.remove('opacity-0');
      deptChartEl.classList.add('opacity-100');
      courseChartEl.classList.remove('opacity-100');
      courseChartEl.classList.add('opacity-0');
      
      // Update chart if needed
      deptChart.update();
    }
  });

  // Course tab click handler
  tabCourse.addEventListener('click', function() {
    if (this.classList.contains('bg-white')) {
      this.classList.remove('bg-white', 'text-gray-700');
      this.classList.add('bg-primary', 'text-white');
      tabDepartment.classList.remove('bg-primary', 'text-white');
      tabDepartment.classList.add('bg-white', 'text-gray-700');
      
      courseChartEl.classList.remove('opacity-0');
      courseChartEl.classList.add('opacity-100');
      deptChartEl.classList.remove('opacity-100');
      deptChartEl.classList.add('opacity-0');
      
      // Update chart if needed
      courseChart.update();
    }
  });

  // Add hover effect for 3D look
  function addHoverEffect(chart) {
    const canvas = chart.canvas;
    
    canvas.addEventListener('mousemove', function(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Get the arc under the cursor
      const arc = chart.getElementsAtEventForMode(
        e, 'nearest', { intersect: true }, false
      );
      
      // Change cursor style
      canvas.style.cursor = arc.length ? 'pointer' : 'default';
      
      // Add subtle shadow effect on hover
      if (arc.length) {
        const meta = chart.getDatasetMeta(0);
        const arcIndex = arc[0].index;
        
        // Reset all arcs
        meta.data.forEach((arc, i) => {
          arc.custom = arc.custom || {};
          arc.custom.borderWidth = 0;
          arc.custom.shadowColor = 'transparent';
        });
        
        // Highlight the hovered arc
        const hoveredArc = meta.data[arcIndex];
        hoveredArc.custom = hoveredArc.custom || {};
        hoveredArc.custom.borderWidth = 2;
        hoveredArc.custom.shadowColor = 'rgba(0,0,0,0.2)';
        
        chart.update();
      }
    });
    
    // Reset on mouse leave
    canvas.addEventListener('mouseleave', function() {
      const meta = chart.getDatasetMeta(0);
      meta.data.forEach(arc => {
        arc.custom = { borderWidth: 0, shadowColor: 'transparent' };
      });
      chart.update();
    });
  }

  // Apply hover effects
  addHoverEffect(deptChart);
  addHoverEffect(courseChart);
</script>

<?php include_once __DIR__ . '/../../components/admin-footer.php'; ?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   